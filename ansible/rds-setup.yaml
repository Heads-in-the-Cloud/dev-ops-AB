---
- hosts: 127.0.0.1
  connection: local

  vars:
## Get output.tf from S3
    project_id: AB
    vpc_id:
    private_subnets:
      -
      -
    #public_subnets:
    #  -
    #  -
## Obtain db root & user creds from secrets manager
    root_username: root
    root_password: temp
    user_username: user
    user_password: temp

  tasks:

## Create RDS w/ admin creds
- name: Create RDS instance
  community.aws.rds_instance:
    id: rds
    identifier: "db-{{ lower(project_id) }}"
    allocated_storage: 10
    engine: mysql
    engine_version: 8.0
    db_instance_class: db.t2.micro
    name: utopia
    username: "{{ root_username }}"
    password: "{{ root_password }}"
    skip_final_snapshot: True
    subnet_group_name: "{{ rds_subnets.name }}"
    vpc_security_group_ids: "{{ sec_group.id }}"

## Wait for RDS to become available
## Create Bastion as EC2 instance w/ AMI, SecGroup, & S3 read permissions from IAM
## Have user_data create DB schema & DB user using root creds and poweroff EC2 instance
